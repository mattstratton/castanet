{{ if isset .Site.Params "enable_jumbo" }}
  {{ if eq .Site.Params.enable_jumbo "true" }}
    {{- partial "jumbotron.html" . }}
  {{ end }}
{{ end }}

{{ if and (and (isset .Site.Params "show_next_upcoming") (eq .Site.Params.show_next_upcoming "true")) (ge (len (where ( where site.RegularPages "Type" "in" site.Params.mainSections) ".Params.upcoming" "==" true )) 1) }}
<div class="w-full bg-castanet-primary-50 p-4 mb-6 rounded-lg shadow">
  <div class="w-full max-w-5xl mx-auto px-4">
    {{ range first 1 (where ( where site.RegularPages "Type" "in" site.Params.mainSections).ByDate ".Params.upcoming" "==" true ) }}
    <p class="text-blue-800">
      Next Episode: <a href="{{ .Permalink }}" class="text-blue-600 hover:text-blue-800 font-medium">{{ .Title }}</a> - Scheduled for {{ dateFormat "Jan 2, 2006" .Date }}
    </p>
    {{ end }}
  </div>
</div>
{{ end }}

<div class="w-full max-w-5xl mx-auto px-4 bg-castanet-primary-50 dark:bg-castanet-primary-900 rounded-lg shadow">
  <div class="mb-8 p-5">
    <h2 class="text-3xl font-bold text-castanet-primary-900 dark:text-white mb-4">
      Latest Episode
    </h2>

    {{ range first 1 (where ( where site.RegularPages "Type" "in" site.Params.mainSections) ".Params.upcoming" "!=" true ) }}
      {{- with .Params.truncate -}}
        {{- $.Scratch.Set "truncate" . }}
      {{- else -}}
        {{- with .Site.Params.truncate -}}
          {{- $.Scratch.Set "truncate" . }}
        {{- else -}}
          {{- $.Scratch.Set "truncate" 600 -}}
        {{- end -}}
      {{- end -}}
      {{- with .Params.youtube -}}
        {{- if . -}}
          {{- $.Scratch.Set "youtube" "true" -}}
        {{- end -}}
      {{- end -}}
      {{- with .Params.episode_banner -}}
        {{- $.Scratch.Set "episode_banner" "true" -}}
      {{- end -}}

      {{/* Begin youtube */}}
      {{- if eq ($.Scratch.Get "youtube") "true" -}}
        <div class="mb-6">
          {{ if and (isset .Site.Params "episode_number_style") (.Params.episode) }}
            {{ if eq .Site.Params.episode_number_style "parens" }}            
              <h2 class="text-2xl font-bold mb-2"><a href="{{ .Permalink }}" class="text-castanet-primary-900 hover:text-blue-600 dark:text-white">{{ .Title }}</a> ({{ with .Site.Params.episode_number_prefix }}{{ . }}{{ end }}{{ .Params.episode }})</h2>
            {{ else if eq .Site.Params.episode_number_style "brackets" }}
              <h2 class="text-2xl font-bold mb-2"><a href="{{ .Permalink }}" class="text-castanet-primary-900 hover:text-blue-600 dark:text-white">{{ .Title }}</a> [{{ with .Site.Params.episode_number_prefix }}{{ . }}{{ end }}{{ .Params.episode }}]</h2>
            {{ else if eq .Site.Params.episode_number_style "dash" }}
              <h2 class="text-2xl font-bold mb-2"><a href="{{ .Permalink }}" class="text-castanet-primary-900 hover:text-blue-600 dark:text-white">{{ .Title }}</a> - {{ with .Site.Params.episode_number_prefix }}{{ . }}{{ end }}{{ .Params.episode }}</h2>
            {{ else }}
              <h2 class="text-2xl font-bold mb-2"><a href="{{ .Permalink }}" class="text-castanet-primary-900 hover:text-blue-600 dark:text-white">{{ .Title }}</a> ({{ with .Site.Params.episode_number_prefix }}{{ . }}{{ end }}{{ .Params.episode }})</h2>
            {{ end }}
          {{ else }}
            <h2 class="text-2xl font-bold mb-2"><a href="{{ .Permalink }}" class="text-castanet-primary-900 hover:text-blue-600 dark:text-white">{{ .Title }}</a></h2>
          {{ end }}        
          <p class="text-sm text-castanet-primary-600 dark:text-white mb-4">Posted on {{ dateFormat "Monday, Jan 2, 2006" .Date }} {{ partial "episode-metadata.html" .}}</p>
        </div>
        <div class="mb-6">
          <div class="aspect-w-16 aspect-h-9">
            <iframe class="w-full h-full rounded-lg shadow-lg" src="//www.youtube.com/embed/{{ .Params.youtube }}" allowfullscreen></iframe>
          </div>
        </div>
        <div class="mb-6">
          <p class="text-castanet-primary-700 dark:text-white">{{ .Description | markdownify | truncate ($.Scratch.Get "truncate") " "}}&nbsp;<a href="{{ .Permalink }}" class="text-blue-600 hover:text-blue-800 dark:text-white text-sm">Read More</a></p>
        </div>
      {{- else if eq ($.Scratch.Get "episode_banner") "true" -}}
        <div class="mb-6">
          {{ if and (isset .Site.Params "episode_number_style") (.Params.episode) }}
            {{ if eq .Site.Params.episode_number_style "parens" }}            
              <h2 class="text-2xl font-bold mb-2"><a href="{{ .Permalink }}" class="text-castanet-primary-900 hover:text-blue-600 dark:text-white">{{ .Title }}</a> ({{ with .Site.Params.episode_number_prefix }}{{ . }}{{ end }}{{ .Params.episode }})</h2>
            {{ else if eq .Site.Params.episode_number_style "brackets" }}
              <h2 class="text-2xl font-bold mb-2"><a href="{{ .Permalink }}" class="text-castanet-primary-900 hover:text-blue-600 dark:text-white">{{ .Title }}</a> [{{ with .Site.Params.episode_number_prefix }}{{ . }}{{ end }}{{ .Params.episode }}]</h2>
            {{ else if eq .Site.Params.episode_number_style "dash" }}
              <h2 class="text-2xl font-bold mb-2"><a href="{{ .Permalink }}" class="text-castanet-primary-900 hover:text-blue-600 dark:text-white">{{ .Title }}</a> - {{ with .Site.Params.episode_number_prefix }}{{ . }}{{ end }}{{ .Params.episode }}</h2>
            {{ else }}
              <h2 class="text-2xl font-bold mb-2"><a href="{{ .Permalink }}" class="text-castanet-primary-900 hover:text-blue-600 dark:text-white">{{ .Title }}</a> ({{ with .Site.Params.episode_number_prefix }}{{ . }}{{ end }}{{ .Params.episode }})</h2>
            {{ end }}
          {{ else }}
            <h2 class="text-2xl font-bold mb-2"><a href="{{ .Permalink }}" class="text-castanet-primary-900 hover:text-blue-600 dark:text-white">{{ .Title }}</a></h2>
          {{ end }} 
          <p class="text-sm text-castanet-primary-600 mb-4 dark:text-white">Posted on {{ dateFormat "Monday, Jan 2, 2006" .Date }} {{ partial "episode-metadata.html" .}}</p>
        </div>
        <div class="mb-6">
          <a href="{{ .Permalink }}"><img src="{{ .Params.episode_banner | absURL }}" class="w-full h-auto rounded-lg shadow-lg"/></a>
        </div>
        <div class="mb-6">
          <p class="text-castanet-primary-700 dark:text-white">{{ .Description | markdownify | truncate ($.Scratch.Get "truncate") " "}}&nbsp;<a href="{{ .Permalink }}" class="text-blue-600 hover:text-blue-800 dark:text-white text-sm">Read More</a></p>
        </div>
      {{- else -}}
        <div class="mb-6">
          <h2 class="text-2xl font-bold mb-2"><a href="{{ .Permalink }}" class="text-castanet-primary-900 hover:text-blue-600 dark:text-white">{{ .Title }}</a></h2>
          <p class="text-sm text-castanet-primary-600 dark:text-white mb-4">Posted on {{ dateFormat "Monday, Jan 2, 2006" .Date }} {{ partial "episode-metadata.html" .}}</p>
        </div>
        {{- if .Params.episode_image -}}
          <div class="flex flex-col md:flex-row gap-6 mb-6">
            <div class="md:w-1/4">
              <a href="{{ .Permalink }}"><img class="w-full h-auto rounded-lg shadow-md" src="{{ .Params.episode_image | absURL }}" /></a>
            </div>
            <div class="md:w-3/4">
              {{- if ge (countrunes .Description ) ($.Scratch.Get "truncate") -}}
                <p class="text-castanet-primary-700 dark:text-white">{{ .Description | markdownify | truncate ($.Scratch.Get "truncate") " "}}&nbsp;<a href="{{ .Permalink }}" class="text-blue-600 hover:text-blue-800 dark:text-white text-sm">Read More</a></p>
              {{- else -}}
                <p class="text-castanet-primary-700 dark:text-white">{{ .Description | markdownify }}</p>
              {{- end -}}
            </div>
          </div>
        {{- else -}}
          <div class="mb-6">
            {{- if ge (countrunes .Description ) ($.Scratch.Get "truncate") -}}
              <p class="text-castanet-primary-700 dark:text-white">{{ .Description | markdownify | truncate ($.Scratch.Get "truncate") " "}}&nbsp;<a href="{{ .Permalink }}" class="text-blue-600 hover:text-blue-800 dark:text-white text-sm">Read More</a></p>
            {{- else -}}
              <p class="text-castanet-primary-700 dark:text-white">{{ .Description | markdownify }}</p>
            {{- end -}}
          </div>
        {{- end -}}
      {{- end -}}
      {{- with .Params.podcast_file -}}
        <div class="mb-6">
          <audio id="player2" class="w-full" width="100%" controls preload="none">
            <source src="{{ $.Site.Params.media_prefix }}{{ . }}" type="audio/mp3">
          </audio>
        </div>
      {{- end -}}
    {{- end -}}
  </div>
</div>

<section class="w-full max-w-5xl mx-auto">
  <!-- rest of episodes -->
  {{- if gt (where ( where site.RegularPages "Type" "in" site.Params.mainSections) ".Params.upcoming" "!=" true ) 1 -}}
  {{- $paginator := .Paginate (after 1 (where ( where site.RegularPages "Type" "in" site.Params.mainSections) ".Params.upcoming" "!=" true )) }}
  {{- $list := (where ( where site.RegularPages "Type" "in" site.Params.mainSections) ".Params.upcoming" "!=" true ) -}}
  {{- $len := (len $list) -}}
  <div class="flex flex-col lg:flex-row gap-8">
    {{- with .Site.Params.enable_jumbo -}}
      {{- if eq . "true" -}}
        <div class="w-full">
      {{- else -}}
        <div class="lg:w-2/3">
      {{- end -}}
    {{- else -}}
      <div class="lg:w-2/3">
    {{- end -}}
    {{- if gt $len 1 -}}
      {{- range $paginator.Pages -}}
        {{ partial "row/episode-row.html" . }}
      {{- end -}}
   
    {{- end -}}
    </div>

 

    {{- if isset .Site.Params "enable_jumbo" -}}
      {{- if ne .Site.Params.enable_jumbo "true" -}}
        <div class="lg:w-1/3">
          {{- partial "sidebar.html" . -}}
        </div>
      {{- end -}}
    {{- else -}}
      <div class="lg:w-1/3">
        {{- partial "sidebar.html" . -}}
      </div>
    {{- end -}}
  </div>

  {{- if gt $paginator.TotalPages 1 -}}
  <div class="mt-8">
    <nav class="flex justify-center">
      {{ $pag := $.Paginator }}
      {{ $window := $.Site.Params.paginateWindow | default 1 }}
      {{ if gt $pag.TotalPages 1 }}
        {{ $total := $pag.TotalPages }}
        {{ $size := add 5 (add $window $window) }}
        {{ $cur := $pag.PageNumber }}
        {{ if gt $total $size }}
          {{ if lt $cur (sub $size (add $window 1)) }}
            {{ $.Scratch.Set "show" (seq 1 (sub $size 2)) }}
          {{ else if lt (sub $total $cur) (sub $size (add $window 2)) }}
            {{ $.Scratch.Set "show" (seq (add (sub $total $size) 3) $total) }}
          {{ else }}
            {{ $.Scratch.Set "show" (seq (sub $cur $window) (add $cur $window)) }}
          {{ end }}
          {{ $.Scratch.Add "show" 1 }}
          {{ $.Scratch.Add "show" $total }}
        {{ else }}
          {{ $.Scratch.Set "show" (seq 1 $total) }}
        {{ end }}

        <ul class="flex space-x-2">
          <!-- first page button -->
          {{if $paginator.HasPrev }}
            {{ if gt $paginator.PageNumber 2 }}
              {{- with $paginator.First -}}
                {{- $url := trim (string .URL) "/" | absURL -}}
                <li>
                  <a href="{{ $url }}" aria-label="First" class="px-3 py-2 rounded-md bg-white text-castanet-primary-700 hover:bg-castanet-primary-50 border border-castanet-primary-300 dark:text-white">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                  </a>
                </li>
              {{- end -}}
            {{ end }}
          {{ end }}

          <!-- prev page button -->
          {{- with $paginator.HasPrev -}}
            <li>
              <a href="{{ $paginator.Prev.URL }}" class="px-3 py-2 rounded-md bg-white text-castanet-primary-700 hover:bg-castanet-primary-50 border border-castanet-primary-300">
                &laquo;
              </a>
            </li>
          {{ end }}
          
          <!-- page # buttons -->
          {{ range $pag.Pagers }}
            {{ $cur := .PageNumber }}
            {{- $url := trim (string .URL) "/" | absURL -}}
            {{ if in ($.Scratch.Get "show") $cur }}
              <li>
                <a href="{{ .URL }}" class="px-3 py-2 rounded-md {{ if eq . $pag }}bg-blue-600 text-white{{ else }}bg-white text-castanet-primary-700 hover:bg-castanet-primary-50{{ end }} border border-castanet-primary-300">
                  {{ .PageNumber }}
                </a>
              </li>
            {{ else if in (slice 2 (sub $total 1)) $cur }}
              <li>
                <span class="px-3 py-2 text-castanet-primary-500">&hellip;</span>
              </li>
            {{ end }}
          {{ end }}
          
          <!-- next page button -->
          {{- with $paginator.HasNext -}}
            <li>
              <a href="{{ $paginator.Next.URL }}" class="px-3 py-2 rounded-md bg-white text-castanet-primary-700 hover:bg-castanet-primary-50 border border-castanet-primary-300">
                &raquo;
              </a>
            </li>
          {{ end }}
          
          <!-- last page button -->
          {{ if lt $paginator.PageNumber (sub $paginator.TotalPages 1) }}
            {{- with $paginator.Last -}}
              {{- $url := trim (string .URL) "/" | absURL -}}
              <li>
                <a href="{{ $url }}" aria-label="Last" class="px-3 py-2 rounded-md bg-white text-castanet-primary-700 hover:bg-castanet-primary-50 border border-castanet-primary-300">
                  <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
              </li>
            {{- end -}}
          {{ end }}
        </ul>
      {{ end }}
    </nav>
  </div>
  {{- end -}}
  {{- end -}}
</section>
